<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>xtas tutorial &mdash; xtas 3.4 documentation</title>
    
    <link rel="stylesheet" href="_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/bootswatch-3.1.0/yeti/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="_static/xtas.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '3.4',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="_static/bootstrap-3.1.0/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="_static/bootstrap-sphinx.js"></script>
    <link rel="top" title="xtas 3.4 documentation" href="index.html" />
    <link rel="next" title="API reference" href="api.html" />
    <link rel="prev" title="Setting up xtas" href="setup.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head>
  <body role="document">

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="index.html">
          xtas</a>
        <span class="navbar-text navbar-version pull-left"><b>3.4</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            <li class="divider-vertical"></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="index.html">Documentation <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul class="current">
<li class="toctree-l1"><a class="reference internal" href="setup.html">Setting up xtas</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="">xtas tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="rest.html">REST API</a></li>
<li class="toctree-l1"><a class="reference internal" href="extending.html">Extending xtas</a></li>
<li class="toctree-l1"><a class="reference internal" href="changelog.html">Changelog/release notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">Frequently anticipated questions</a></li>
</ul>
</ul>
</li>
              
            
            
              
                
  <li>
    <a href="setup.html" title="Previous Chapter: Setting up xtas"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm">&laquo; Setting up xtas</span>
    </a>
  </li>
  <li>
    <a href="api.html" title="Next Chapter: API reference"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm">API reference &raquo;</span>
    </a>
  </li>
              
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12">
      
  <div class="section" id="xtas-tutorial">
<h1>xtas tutorial<a class="headerlink" href="#xtas-tutorial" title="Permalink to this headline">¶</a></h1>
<p>Assuming you&#8217;ve properly configured and started xtas as described in the
README, here&#8217;s how to do interesting work with it.</p>
<p>First, you need a document collection. If you don&#8217;t have one already, download
the 20newsgroups dataset:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>curl http://qwone.com/~jason/20Newsgroups/20news-bydate.tar.gz | tar xzf -
</pre></div>
</div>
<p>Store the documents in Elasticsearch:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">elasticsearch</span> <span class="kn">import</span> <span class="n">Elasticsearch</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">os</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">join</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">es</span> <span class="o">=</span> <span class="n">Elasticsearch</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">files</span> <span class="o">=</span> <span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">fnames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="s1">&#39;20news-bydate-train&#39;</span><span class="p">)</span>
<span class="gp">... </span>         <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fnames</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">body</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="nb">open</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)}</span>
<span class="gp">... </span>    <span class="n">es</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;20news&#39;</span><span class="p">,</span> <span class="n">doc_type</span><span class="o">=</span><span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
<span class="gp">...</span>
</pre></div>
</div>
<p>Now, we can run named-entity recognition on the documents. Let&#8217;s try it on one
document:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">xtas.tasks</span> <span class="kn">import</span> <span class="n">es_document</span><span class="p">,</span> <span class="n">stanford_ner_tag</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">doc</span> <span class="o">=</span> <span class="n">es_document</span><span class="p">(</span><span class="s1">&#39;20news&#39;</span><span class="p">,</span> <span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">tagged</span> <span class="o">=</span> <span class="n">stanford_ner_tag</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="p">[</span><span class="n">token</span> <span class="k">for</span> <span class="n">token</span><span class="p">,</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tagged</span> <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;PERSON&#39;</span><span class="p">]</span>
<span class="go">[&#39;Dane&#39;, &#39;C.&#39;, &#39;Butzer&#39;, &#39;Dane&#39;]</span>
</pre></div>
</div>
<p>We just fetched the document from ES to run Stanford NER locally. That&#8217;s not
the best we can do, so let&#8217;s run it remotely. We can do so by running the
<code class="docutils literal"><span class="pre">stanford_ner_tag</span></code> tasks asynchronously. First, observe that <code class="docutils literal"><span class="pre">doc</span></code> isn&#8217;t
really the document: it&#8217;s only a handle on the ES index:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">doc</span>
<span class="go">{&#39;index&#39;: &#39;20news&#39;, &#39;type&#39;: &#39;post&#39;, &#39;id&#39;: 1, &#39;field&#39;: &#39;text&#39;}</span>
</pre></div>
</div>
<p>This handle can be sent over the wire to make Stanford NER run in the worker:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">result</span> <span class="o">=</span> <span class="n">stanford_ner_tag</span><span class="o">.</span><span class="n">apply_async</span><span class="p">([</span><span class="n">doc</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span>
<span class="go">&lt;AsyncResult: 44128ea3-970c-427c-80cc-2af499426b33&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="p">[</span><span class="n">token</span> <span class="k">for</span> <span class="n">token</span><span class="p">,</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;PERSON&#39;</span><span class="p">]</span>
<span class="go">[u&#39;Dane&#39;, u&#39;C.&#39;, u&#39;Butzer&#39;, u&#39;Dane&#39;]</span>
</pre></div>
</div>
<p>We have the same result, but now from a worker process. The <code class="docutils literal"><span class="pre">result</span></code> object
is an <code class="docutils literal"><span class="pre">AsyncResult</span></code> returned by Celery; see
<a class="reference external" href="http://docs.celeryproject.org/en/latest/">its documentation</a> for full
details.</p>
<div class="section" id="batch-tasks">
<h2>Batch tasks<a class="headerlink" href="#batch-tasks" title="Permalink to this headline">¶</a></h2>
<p>Some tasks require a batch of documents to work; an example is topic modeling.
Such tasks are available in the <code class="docutils literal"><span class="pre">xtas.tasks.cluster</span></code> package,
so named because most of the tasks can be considered a form of clustering.
Batches of documents are addressed using Elasticsearch queries,
which can be performed using xtas.
For example, to search for the word &#8220;hello&#8221; in the 20news collection:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">xtas.tasks.es</span> <span class="kn">import</span> <span class="n">fetch_query_batch</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">hello</span> <span class="o">=</span> <span class="n">fetch_query_batch</span><span class="p">(</span><span class="s1">&#39;20news&#39;</span><span class="p">,</span> <span class="s1">&#39;post&#39;</span><span class="p">,</span>
<span class="gp">... </span>                          <span class="p">{</span><span class="s1">&#39;term&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="s1">&#39;hello&#39;</span><span class="p">}},</span> <span class="s1">&#39;text&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">len</span><span class="p">(</span><span class="n">hello</span><span class="p">)</span>
<span class="go">10</span>
</pre></div>
</div>
<p>This fetches the <code class="docutils literal"><span class="pre">'text'</span></code> field of the documents that match the query.
(<code class="docutils literal"><span class="pre">'text'</span></code> appears twice since you might want to match on the title,
but retrieve the body text, etc.)</p>
<p>Now we can fit a topic model to these document. (You need the gensim package
for this, <code class="docutils literal"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">gensim</span></code>.) Try:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">xtas.tasks.cluster</span> <span class="kn">import</span> <span class="n">lda</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pprint</span><span class="p">(</span><span class="n">lda</span><span class="p">(</span><span class="n">hello</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pprint</span><span class="p">(</span><span class="n">lda</span><span class="p">(</span><span class="n">hello</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="go">[[(u&#39;and&#39;, 0.12790937338676811),</span>
<span class="go">  (u&#39;am&#39;, 0.1152182699301362),</span>
<span class="go">  (u&#39;any&#39;, 0.11363680997981712),</span>
<span class="go">  (u&#39;application&#39;, 0.10684945575768415),</span>
<span class="go">  (u&#39;algorithm&#39;, 0.10684176173416),</span>
<span class="go">  (u&#39;advance&#39;, 0.096258764014596071),</span>
<span class="go">  (u&#39;be&#39;, 0.089261082314667867),</span>
<span class="go">  (u&#39;anyone&#39;, 0.088502698282068443),</span>
<span class="go">  (u&#39;an&#39;, 0.087148958488685924),</span>
<span class="go">  (u&#39;ac&#39;, 0.068372826111416152)],</span>
<span class="go"> [(u&#39;and&#39;, 0.1150624380922104),</span>
<span class="go">  (u&#39;application&#39;, 0.11312568874979338),</span>
<span class="go">  (u&#39;anyone&#39;, 0.10728409178444523),</span>
<span class="go">  (u&#39;advance&#39;, 0.10695761539379559),</span>
<span class="go">  (u&#39;algorithm&#39;, 0.10218031622874352),</span>
<span class="go">  (u&#39;be&#39;, 0.10193138214362385),</span>
<span class="go">  (u&#39;any&#39;, 0.098412728034106681),</span>
<span class="go">  (u&#39;am&#39;, 0.097021607665297285),</span>
<span class="go">  (u&#39;an&#39;, 0.089350803758697001),</span>
<span class="go">  (u&#39;ac&#39;, 0.06867332814928688)]]</span>
</pre></div>
</div>
<p>Here, the <code class="docutils literal"><span class="pre">lda</span></code> task returns (term, weight) pairs for two topics.
Admittedly, the topics aren&#8217;t very pretty on this small set.</p>
<p>Of course, fetching the documents and running the topic model locally isn&#8217;t
optimal use of xtas. Instead, let&#8217;s set up a <em>chain</em> of tasks that runs the
query and fetches the results on a worker node, then runs the topic model
remotely as well. We&#8217;ll use Celery syntax to accomplish this:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">chain</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">fetch</span> <span class="o">=</span> <span class="n">fetch_query_batch</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="s1">&#39;20news&#39;</span><span class="p">,</span> <span class="s1">&#39;post&#39;</span><span class="p">,</span>
<span class="gp">... </span>                            <span class="p">{</span><span class="s1">&#39;term&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="s1">&#39;hello&#39;</span><span class="p">}},</span> <span class="s1">&#39;text&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">fetch_lda</span> <span class="o">=</span> <span class="n">chain</span><span class="p">(</span><span class="n">fetch</span><span class="p">,</span> <span class="n">lda</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>    <span class="c1"># make a chain</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span> <span class="o">=</span> <span class="n">fetch_lda</span><span class="p">()</span>                    <span class="c1"># run the chain</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pprint</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>                    <span class="c1"># get results and display them</span>
<span class="go">[[[u&#39;application&#39;, 0.11542413644453535],</span>
<span class="go">  [u&#39;am&#39;, 0.11459672375838384],</span>
<span class="go">  [u&#39;and&#39;, 0.11376035386021534],</span>
<span class="go">  [u&#39;algorithm&#39;, 0.11359529150248926],</span>
<span class="go">  [u&#39;advance&#39;, 0.10468087522675153],</span>
<span class="go">  [u&#39;be&#39;, 0.10361386971376114],</span>
<span class="go">  [u&#39;any&#39;, 0.10321250189311466],</span>
<span class="go">  [u&#39;anyone&#39;, 0.08927608350583244],</span>
<span class="go">  [u&#39;an&#39;, 0.08631073215334073],</span>
<span class="go">  [u&#39;ac&#39;, 0.055529431941575814]],</span>
<span class="go"> [[u&#39;and&#39;, 0.12924727078744289],</span>
<span class="go">  [u&#39;any&#39;, 0.1088955461011441],</span>
<span class="go">  [u&#39;anyone&#39;, 0.10640790208811389],</span>
<span class="go">  [u&#39;application&#39;, 0.10453772359410955],</span>
<span class="go">  [u&#39;advance&#39;, 0.09849716348992137],</span>
<span class="go">  [u&#39;am&#39;, 0.09774308133723099],</span>
<span class="go">  [u&#39;algorithm&#39;, 0.09546989905871668],</span>
<span class="go">  [u&#39;an&#39;, 0.09017462431916073],</span>
<span class="go">  [u&#39;be&#39;, 0.08754428312668586],</span>
<span class="go">  [u&#39;ac&#39;, 0.0814825060974741]]]</span>
</pre></div>
</div>
<p>More details on creating chains can be found in the <a class="reference external" href="http://celery.readthedocs.org/en/latest/userguide/canvas.html#chains">Celery userguide</a>.</p>
</div>
<div class="section" id="storing-results">
<h2>Storing results<a class="headerlink" href="#storing-results" title="Permalink to this headline">¶</a></h2>
<p>We just saw how to run jobs remotely, fetching documents from an Elasticsearch
index. What is even more interesting is that we can also store results back to
ES, so we can use xtas as preprocessing for a semantic search engine.</p>
<p>We can use the <code class="docutils literal"><span class="pre">store_single</span></code> task to run NER on a document from the index
and store the result back, if we append it to our chain:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">chain</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">xtas.tasks.es</span> <span class="kn">import</span> <span class="n">store_single</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">doc</span> <span class="o">=</span> <span class="n">es_document</span><span class="p">(</span><span class="s1">&#39;20news&#39;</span><span class="p">,</span> <span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="mi">3430</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ch</span> <span class="o">=</span> <span class="n">chain</span><span class="p">(</span><span class="n">stanford_ner_tag</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="s2">&quot;names&quot;</span><span class="p">),</span>
<span class="gp">... </span>           <span class="n">store_single</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="s1">&#39;ner&#39;</span><span class="p">,</span> <span class="n">doc</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">],</span> <span class="n">doc</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">],</span> <span class="n">doc</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span> <span class="o">=</span> <span class="n">ch</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pprint</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
<span class="go">[[u&#39;School of Computer Science&#39;, u&#39;ORGANIZATION&#39;],</span>
<span class="go"> [u&#39;McGill University Lines&#39;, u&#39;ORGANIZATION&#39;],</span>
<span class="go"> [u&#39;Sony&#39;, u&#39;ORGANIZATION&#39;],</span>
<span class="go"> [u&#39;SONY&#39;, u&#39;ORGANIZATION&#39;],</span>
<span class="go"> [u&#39;Invar Shadow Mask&#39;, u&#39;ORGANIZATION&#39;],</span>
<span class="go"> [u&#39;NEC&#39;, u&#39;ORGANIZATION&#39;],</span>
<span class="go"> [u&#39;NEC&#39;, u&#39;ORGANIZATION&#39;],</span>
<span class="go"> [u&#39;Tony&#39;, u&#39;PERSON&#39;],</span>
<span class="go"> [u&#39;McGill University&#39;, u&#39;ORGANIZATION&#39;],</span>
<span class="go"> [u&#39;Floyd&#39;, u&#39;PERSON&#39;]]</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">result.get()</span></code> will now report the output from the NER tagger, but getting it
locally is not what we&#8217;re after. The <code class="docutils literal"><span class="pre">store_single</span></code> task has also stored the
result back into the document, as you can verify with:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">xtas.tasks</span> <span class="kn">import</span> <span class="n">get_all_results</span><span class="p">,</span> <span class="n">get_single_result</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pprint</span><span class="p">(</span><span class="n">get_all_results</span><span class="p">(</span><span class="n">doc</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">],</span> <span class="n">doc</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">],</span> <span class="n">doc</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]))</span>
<span class="go">{u&#39;ner&#39;: [[u&#39;Christopher Taylor&#39;, u&#39;PERSON&#39;],</span>
<span class="go">          [u&#39;Bradley University Distribution&#39;, u&#39;ORGANIZATION&#39;],</span>
<span class="go">          [u&#39;NHL&#39;, u&#39;ORGANIZATION&#39;]],</span>
<span class="go">}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pprint</span><span class="p">(</span><span class="n">get_single_result</span><span class="p">(</span><span class="s1">&#39;ner&#39;</span><span class="p">,</span> <span class="n">doc</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">],</span> <span class="n">doc</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">],</span> <span class="n">doc</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]))</span>
<span class="go">[[u&#39;Christopher Taylor&#39;, u&#39;PERSON&#39;],</span>
<span class="go"> [u&#39;Bradley University Distribution&#39;, u&#39;ORGANIZATION&#39;],</span>
<span class="go"> [u&#39;NHL&#39;, u&#39;ORGANIZATION&#39;]]</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">get_all_results</span></code> returns all results for a document,
while <code class="docutils literal"><span class="pre">get_single_result</span></code> only returns the results for a specific taskname
(in our case specified as <code class="docutils literal"><span class="pre">&quot;ner&quot;</span></code>).
But what if we had the task run forever ago and can&#8217;t remember the tasks
that were run on a specific index?</p>
<dl class="docutils">
<dt>::</dt>
<dd><div class="first last highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">pprint</span><span class="p">(</span><span class="n">get_tasks_per_index</span><span class="p">(</span><span class="n">doc</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">],</span> <span class="n">doc</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]))</span>
<span class="go">set([u&#39;ner&#39;])</span>
</pre></div>
</div>
</dd>
</dl>
<p>We can now actually query the xtas results.
Let&#8217;s say we are interested in all documents that contain a PERSON name,
as identified by the named entity recognition:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">xtas.tasks</span> <span class="kn">import</span> <span class="n">fetch_documents_by_task</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">query</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;match&quot;</span> <span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;data&quot;</span> <span class="p">:</span> <span class="p">{</span><span class="s2">&quot;query&quot;</span><span class="p">:</span><span class="s2">&quot;PERSON&quot;</span><span class="p">}}}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pprint</span><span class="p">(</span><span class="n">fetch_documents_by_task</span><span class="p">(</span><span class="s1">&#39;20news&#39;</span><span class="p">,</span> <span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="s1">&#39;ner&#39;</span><span class="p">,</span> <span class="n">full</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
<span class="go">[[u&#39;3430&#39;,</span>
<span class="go">  {u&#39;_id&#39;: u&#39;3430&#39;,</span>
<span class="go">   u&#39;_index&#39;: u&#39;20news&#39;,</span>
<span class="go">   u&#39;_score&#39;: 1.0,</span>
<span class="go">   u&#39;_source&#39;: {u&#39;text&#39;: u&quot;From: nittmo@camelot.bradley.edu (Christopher Taylor)\nSubject: Anyone Have Official Shorthanded Goal Totals?\nNntp-Posting-Host: camelot.bradley.edu\nOrganization: Bradley University\nDistribution: na\nLines: 4\n\nDoes anyone out there have the shorthanded goal totals of the NHL players\nfor this season?  We&#39;re trying to finish our rotisserie stats and need SHG\nto make it complete.\n\n&quot;},</span>
<span class="go">   u&#39;_type&#39;: u&#39;post&#39;,</span>
<span class="go">   u&#39;ner&#39;: [[u&#39;Christopher Taylor&#39;, u&#39;PERSON&#39;],</span>
<span class="go">            [u&#39;Bradley University Distribution&#39;, u&#39;ORGANIZATION&#39;],</span>
<span class="go">            [u&#39;NHL&#39;, u&#39;ORGANIZATION&#39;]]}]]</span>
</pre></div>
</div>
<p>We now query only the results of the NER task!
The parameter <code class="docutils literal"><span class="pre">full=True</span></code> returns the full documents,
i.e., includes the results of the task as well.
The results of the xtas task are always stored in the <code class="docutils literal"><span class="pre">data</span></code> field:
make sure to take that into account when building your queries.</p>
<p>We can see that NHL is classified as an organisation.
What if we would like to query all occurences of NHL
to see if it is consistently classified as organisation?</p>
<dl class="docutils">
<dt>::</dt>
<dd><div class="first last highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">xtas.tasks</span> <span class="kn">import</span> <span class="n">fetch_results_by_document</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">query</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;match&quot;</span> <span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;text&quot;</span> <span class="p">:</span> <span class="p">{</span><span class="s2">&quot;query&quot;</span><span class="p">:</span><span class="s2">&quot;NHL&quot;</span><span class="p">}}}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pprint</span><span class="p">(</span><span class="n">fetch_results_by_document</span><span class="p">(</span><span class="s1">&#39;20news&#39;</span><span class="p">,</span> <span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="s1">&#39;ner&#39;</span><span class="p">))</span>
<span class="go">[[u&#39;3430&#39;,</span>
<span class="go">  {u&#39;_id&#39;: u&#39;3430&#39;,</span>
<span class="go">   u&#39;_index&#39;: u&#39;20news&#39;,</span>
<span class="go">   u&#39;_score&#39;: 1.0,</span>
<span class="go">   u&#39;_source&#39;: {u&#39;data&#39;: [[u&#39;Christopher Taylor&#39;, u&#39;PERSON&#39;],</span>
<span class="go">                          [u&#39;Bradley University Distribution&#39;,</span>
<span class="go">                           u&#39;ORGANIZATION&#39;],</span>
<span class="go">                          [u&#39;NHL&#39;, u&#39;ORGANIZATION&#39;]],</span>
<span class="go">                u&#39;timestamp&#39;: u&#39;2014-12-18T10:57:37.259356&#39;},</span>
<span class="go">   u&#39;_type&#39;: u&#39;post__ner&#39;}]]</span>
</pre></div>
</div>
</dd>
</dl>
<p>Those two functions are convenience wrappers for the actual query function
<code class="docutils literal"><span class="pre">fetch_query_details_batch</span></code>:
here we can fire any elastic search query and get all results in a batch.
If we would want to have a simple query for all documents containing NHL,
we would say:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">xtas.tasks</span> <span class="kn">import</span> <span class="n">fetch_query_details_batch</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">query</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;match&quot;</span> <span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;text&quot;</span> <span class="p">:</span> <span class="p">{</span><span class="s2">&quot;query&quot;</span><span class="p">:</span><span class="s2">&quot;NHL&quot;</span><span class="p">}}}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pprint</span><span class="p">(</span><span class="n">fetch_query_details_batch</span><span class="p">(</span><span class="s1">&#39;20news&#39;</span><span class="p">,</span> <span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="bp">True</span><span class="p">))</span>
<span class="go">[[u&#39;3362&#39;,</span>
<span class="go">  {u&#39;_id&#39;: u&#39;3362&#39;,</span>
<span class="go">   u&#39;_index&#39;: u&#39;20news&#39;,</span>
<span class="go">   u&#39;_score&#39;: 0.8946465,</span>
<span class="go">   u&#39;_source&#39;: {u&#39;text&#39;: u&#39;From: mmilitzo@scott.skidmore.edu (matthew militzok)\nSubject: 1992 - 1993 FINAL NHL PLAYER STATS\nOrganization: Skidmo</span>
<span class="go">.... cut ....</span>
<span class="go">]]</span>
</pre></div>
</div>
<p>When multiple tasks were performed on the index,
<code class="docutils literal"><span class="pre">tasknames</span></code> restricts the returned annotation results
to the ones in that list.</p>
<p>More complex queries can be built,
including relations between the between the different tasks and the documents.
Keep in mind that the type of a task is (currently)
a concatenation of the type of the original document and the taskname.
The query build to fetch a document by its task is then:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">query</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;has_child&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;query&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;match&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;query&#39;</span><span class="p">:</span> <span class="s1">&#39;PERSON&#39;</span><span class="p">}}},</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;post__ner&#39;</span><span class="p">}}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pprint</span><span class="p">(</span><span class="n">fetch_query_details_batch</span><span class="p">(</span><span class="s1">&#39;20news&#39;</span><span class="p">,</span> <span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="bp">True</span><span class="p">))</span>
<span class="go">[[u&#39;3430&#39;,</span>
<span class="go">  {u&#39;_id&#39;: u&#39;3430&#39;,</span>
<span class="go">   u&#39;_index&#39;: u&#39;20news&#39;,</span>
<span class="go">   u&#39;_score&#39;: 1.0,</span>
<span class="go">   u&#39;_source&#39;: {u&#39;text&#39;: u&quot;From: nittmo@camelot.bradley.edu (Christopher Taylor)\nSubject: Anyone Have Official Shorthanded Goal Totals?\nNntp-Posting-Host: camelot.bradley.edu\nOrganization: Bradley University\nDistribution: na\nLines: 4\n\nDoes anyone out there have the shorthanded goal totals of the NHL players\nfor this season?  We&#39;re trying to finish our rotisserie stats and need SHG\nto make it complete.\n\n&quot;},</span>
<span class="go">   u&#39;_type&#39;: u&#39;post&#39;,</span>
<span class="go">   u&#39;ner&#39;: [[u&#39;Christopher Taylor&#39;, u&#39;PERSON&#39;],</span>
<span class="go">            [u&#39;Bradley University Distribution&#39;, u&#39;ORGANIZATION&#39;],</span>
<span class="go">            [u&#39;NHL&#39;, u&#39;ORGANIZATION&#39;]]}]]</span>
</pre></div>
</div>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
        <br/>
        
<div id="sourcelink">
  <a href="_sources/tutorial.txt"
     rel="nofollow">Source</a>
</div>
      
    </p>
    <p>
        &copy; Copyright 2013–2015 Netherlands eScience Center, University of Amsterdam.<br/>
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.3.5.<br/>
    </p>
  </div>
</footer>
  </body>
</html>